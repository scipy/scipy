build_and_store_wheels: &BUILD_AND_STORE_WHEELS
  install_cibuildwheel_script:
    - python -m pip install cibuildwheel==2.10.1
  cibuildwheel_script:
    - cibuildwheel
  wheels_artifacts:
    path: "wheelhouse/*"


######################################################################
# Should wheels be built?
# Test if the run was triggered by:
# - a cron job. The cron job is not set in this file, but on the
#   cirrus-ci repo page
# - commit message containing [wheel build]
# - a tag that begins with v, but doesn't end with dev0
######################################################################

cirrus_wheel_trigger_task:
  only_if: $CIRRUS_REPO_FULL_NAME == "scipy/scipy"
  compute_engine_instance:
    image_project: cirrus-images
    image: family/docker-builder
    platform: linux
    cpu: 2
    memory: 4G

  script: |
    set -xe
    
    COMMIT_MSG=$(git log --no-merges -1)
    if [[ "$COMMIT_MSG" == *"[wheel build]"* ]]; then
      exit 0
    elif [[ "$CIRRUS_CRON" == "nightly" ]]; then
      exit 0
    elif [[ $CIRRUS_TAG =~ ^v.*[^dev0]$ ]]; then
      exit 0
    else
      exit 1
    fi


######################################################################
# Build linux_aarch64 natively
######################################################################

cirrus_wheels_linux_aarch64_task:
  only_if: $CIRRUS_REPO_FULL_NAME == "scipy/scipy"
  depends_on: cirrus_wheel_trigger
  compute_engine_instance:
    image_project: cirrus-images
    image: family/docker-builder-arm64
    architecture: arm64
    platform: linux
    cpu: 4
    memory: 8G
  matrix:
    - env:
        CIBW_BUILD: cp38-* cp39-*
    - env:
        CIBW_BUILD: cp310-* cp311-*
  build_script:
    - apt install -y python3-venv python-is-python3
    - which python
    # needed for submodules
    - git submodule update --init
  <<: *BUILD_AND_STORE_WHEELS


######################################################################
# Build macosx_arm64 natively
######################################################################

cirrus_wheels_macos_arm64_task:
  only_if: $CIRRUS_REPO_FULL_NAME == "scipy/scipy"
  depends_on: cirrus_wheel_trigger
  macos_instance:
    image: ghcr.io/cirruslabs/macos-monterey-xcode:13.3.1
  matrix:
    - env:
        CIBW_BUILD: cp39-*
    - env:
        CIBW_BUILD: cp310-* cp311-*
  env:
    PATH: /opt/homebrew/opt/python@3.10/bin:$PATH
    CIBW_ENVIRONMENT: MACOSX_DEPLOYMENT_TARGET=12.0 _PYTHON_HOST_PLATFORM="macosx-12.0-arm64"
    PKG_CONFIG_PATH: /opt/arm64-builds/lib/pkgconfig
    # assumes that the cmake config is in /usr/local/lib/cmake
    CMAKE_PREFIX_PATH: /opt/arm64-builds/
    REPAIR_PATH: /usr/local/gfortran/lib:/opt/arm64-builds/lib
    CIBW_REPAIR_WHEEL_COMMAND_MACOS: >
      DYLD_LIBRARY_PATH=/usr/local/gfortran/lib:/opt/arm64-builds/lib delocate-listdeps {wheel} &&
      DYLD_LIBRARY_PATH=/usr/local/gfortran/lib:/opt/arm64-builds/lib delocate-wheel --require-archs {delocate_archs} -w {dest_dir} {wheel}
  install_pre_requirements_script:
    - brew install python@3.10
    - ln -s python3 /opt/homebrew/opt/python@3.10/bin/python

  build_script:
    - which python
    # needed for submodules
    - git submodule update --init
    - uname -m
    - python -c "import platform;print(platform.python_version());print(platform.system());print(platform.machine())"
    - clang --version
  <<: *BUILD_AND_STORE_WHEELS

######################################################################
# Upload all wheels
######################################################################

cirrus_wheels_upload_task:
  # Artifacts don't seem to be persistent from task to task.
  # Rather than upload wheels at the end of each cibuildwheel run we do a
  # final upload here. This is because a run may be on different OS for
  # which bash, etc, may not be present.

  only_if: $CIRRUS_REPO_FULL_NAME == "scipy/scipy"
  depends_on:
    - cirrus_wheels_linux_aarch64
    - cirrus_wheels_macos_arm64
  compute_engine_instance:
    image_project: cirrus-images
    image: family/docker-builder
    platform: linux
    cpu: 2
    memory: 4G

  env:
    # created as SCIPY_STAGING_UPLOAD_TOKEN_CIRRUS and SCIPY_NIGHTLY_UPLOAD_TOKEN_CIRRUS
    SCIPY_STAGING_UPLOAD_TOKEN: ENCRYPTED[92da39a48bc14c0d14f05c057b011e321915337a8e0a664da56be892e3d19c5c991d12bc7ef79470693214620d3e3b1a]
    SCIPY_NIGHTLY_UPLOAD_TOKEN: ENCRYPTED[3084f2103e33493cfc1992a22ec8e67665f835ab31eec7a84711dc9b2f78ea6d6e189e871214b7e9ba41e240ad4f8af4]
  upload_script: |
    apt-get install -y python3-venv python-is-python3 curl
    export IS_SCHEDULE_DISPATCH="false"
    export IS_PUSH="false"

    # cron job
    if [[ "$CIRRUS_CRON" == "nightly" ]]; then
      export IS_SCHEDULE_DISPATCH="true"
    fi
    # it's a tag event starting with 'v' and not ending with 'dev0'
    if [[ $CIRRUS_TAG =~ ^v.*[^dev0]$ ]]; then
          export IS_PUSH="true"
    fi
    
    # The name of the zip file is derived from the `wheels_artifact` line.
    # If you change the artifact line to `myfile_artifact` then it would be
    # called myfile.zip
    
    curl https://api.cirrus-ci.com/v1/artifact/build/$CIRRUS_BUILD_ID/wheels.zip --output wheels.zip
    unzip wheels.zip
    
    source tools/wheels/upload_wheels.sh
    set_upload_vars
    # trigger an upload to
    # https://anaconda.org/scipy-wheels-nightly/scipy
    # for cron jobs or "Run workflow" (restricted to main branch).
    # Tags will upload to
    # https://anaconda.org/multibuild-wheels-staging/scipy
    # The tokens were originally generated at anaconda.org
    upload_wheels
